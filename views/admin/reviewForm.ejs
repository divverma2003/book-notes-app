<main class="form-container">
  <h2 class="form-title"><%= locals.review ? 'Edit Review' : 'Add Review' %></h2>

  <% if (error) { %>
    <p class="form-error"><%= error %></p>
  <% } %>

  <form
    action="<%= locals.review ? `/auth/${user.user_id}/edit-review/${review.review_id}` : `/auth/${user.user_id}/add-review` %>"
    method="POST"
    class="form"
  >
  <% if (locals.review) { %>
      <input type="hidden" name="review_id" value="<%= review.review_id %>" />
    <% } %>

    <input type="hidden" name="user_id" value="<%= user.user_id %>" />

    <label for="<%= locals.review ? 'book' : 'book_id' %>">Book</label>
      <% if (locals.review) { %>
        <!-- Show book title readonly when editing -->
        <input
          type="text"
          id="book"
          value="<%= review.book_title %>"
          readonly
          class="readonly-input"
        />
        <input type="hidden" name="book_id" value="<%= review.book_id %>" />
      <% } else { %>
        <!-- On add, let user select book -->
        <select id="book_id" name="book_id" required>
          <option value="" disabled <%= locals.book ? '' : 'selected' %>>Select a book</option>
          <% books.forEach(b => { %>
            <option
              value="<%= b.book_id %>"
              <%= locals.book && String(b.book_id) === String(locals.book.book_id) ? 'selected' : '' %>>
              <%= b.title %>
            </option>
          <% }) %>
        </select>
      <% } %>

    <label for="rating">Rating (1-10)</label>
    <input
      type="number"
      id="rating"
      name="rating"
      min="1"
      max="10"
      required
      value="<%= locals.review ? review.rating : '' %>"
    />

    <label for="short_description">Short Description</label>
    <input
      type="text"
      id="short_description"
      name="short_description"
      maxlength="255"
      required
      value="<%= locals.review ? review.short_description : '' %>"
    />

    <label for="long_description">Long Description</label>
    <textarea
      id="long_description"
      name="long_description"
      rows="5"
      placeholder="Write a detailed review..."
    ><%= locals.review ? review.long_description : '' %></textarea>

    <button type="submit" class="btn btn-primary">
      <%= locals.review ? 'Save Changes' : 'Add Review' %>
    </button>
    </form>

    <% if (locals.review) { %>
    <!-- Delete Button triggers modal -->
    <button type="button" class="btn btn-danger btn-center" id="openDeleteModalReview">
          Delete Review
    </button>

      <!-- Delete Modal -->
      <div id="deleteModalReview" class="modal-overlay" style="display:none;">
          <div class="modal-content">
              <h3>Confirm Deletion</h3>
              <p>Are you sure you want to delete this review? This action cannot be undone.</p>

            <form action="/auth/<%= user.user_id %>/delete-review/<%= review.review_id %>" method="POST">
                <button type="submit" class="btn btn-danger">Yes, Delete</button>
                <button type="button" class="btn btn-secondary" id="cancelDeleteReview">Cancel</button>
            </form>
            </div>
        </div>
    <% } %>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const deleteBtn = document.getElementById("openDeleteModalReview");
    const deleteModal = document.getElementById("deleteModalReview");
    const cancelDelete = document.getElementById("cancelDeleteReview");

    if (deleteBtn && deleteModal && cancelDelete) {
      deleteBtn.addEventListener("click", () => {
        deleteModal.style.display = "flex"; 
      });
      cancelDelete.addEventListener("click", () => {
        deleteModal.style.display = "none";
      });
    }
  });
</script>