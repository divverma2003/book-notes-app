      <!-- User Banner -->
    <section class="user-banner" style ="--user-color: <%= user.user_color || '#a2c2e0' %>;">
    <div class="user-info">
      <h1><%= user.name %>‚Äôs Dashboard</h1>
      <ul class="user-details">
        <li><strong>User ID:</strong> <%= user.user_id %></li>
        <li><strong>Email:</strong> <%= user.email %></li>
        <li><strong>About:</strong> <%= user.about || 'N/A' %></li>
        <li><strong>Phone:</strong> <%= user.phone_number || 'N/A' %></li>
        <li><strong>Review Count:</strong> <%= user.review_count %></li>
        <li><strong>Favorite Book:</strong> 
          <%= user.favorite_book_title ? user.favorite_book_title : 'N/A' %>
        </li>
      </ul>
    </div>
    <a href="/auth/user/<%= user.user_id %>/edit" class="btn btn-edit" title="Edit Profile">‚úèÔ∏è Edit Profile</a>
  </section>
<main class="dashboard-container" >
  <!-- Add Review Section -->
  <section class="add-review-section">
    <h2>
      <button id="toggleAddReview" class="collapsible-toggle" type="button" aria-expanded="false" aria-controls="addReviewContent">
        Add a Review ‚ñ∏
      </button>
    </h2>

    <div id="addReviewContent" class="collapsible-content" hidden>
      <div class="search-box">
        <input
          type="text"
          id="bookSearch"
          class="search-input"
          placeholder="Search books by title..."
          autocomplete="off"
          aria-autocomplete="list"
          aria-controls="bookResults"
        />
      </div>

      <ul id="bookResults" class="search-dropdown" role="listbox" aria-label="Book results"></ul>

      <!-- Fallback complete list (hidden when searching) -->
      <div id="fallbackBooks" class="add-review-buttons">
        <% if (!locals.books || locals.books.length === 0) { %>
          <p>No books available to review. Please add books first.</p>
        <% } else { %>
          <ul class="books-list">
            <% books.forEach(book => { %>
              <li class="book-item">
                <img src="<%= book.book_cover || '/img/placeholder.jpg' %>" alt="Cover of <%= book.title %>" class="review-book-cover" />
                <div class="book-info">
                  <h3><%= book.title %></h3>
                  <p><strong>Author:</strong> <%= book.author %></p>
                  <p><strong>Genre:</strong> <%= book.genre || 'N/A' %></p>

                  <% 
                    var avg = parseFloat(book.average_rating);
                    var hasAvg = !isNaN(avg) && avg > 0;
                    var stars = hasAvg ? Math.round(avg / 2) : 0; // 10-scale to 5 stars
                  %>
                  <div class="star-rating">
                    <% for (var i = 1; i <= 5; i++) { %>
                      <span class="<%= i <= stars ? 'star filled' : 'star' %>">&#9733;</span>
                    <% } %>
                    <% if (hasAvg) { %>
                      <span class="rating-text">(<%= avg.toFixed(1) %>/10)</span>
                    <% } else { %>
                      <span class="rating-text">No ratings yet</span>
                    <% } %>
                  </div>
                </div>
                <div class="book-actions">
                  <a 
                    href="/auth/<%= user.user_id %>/add-review/<%= book.book_id %>" 
                    class="btn btn-review"
                    title="Add review for <%= book.title %>"
                  >
                    üìù Review
                  </a>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Reviews Section -->
  <section class="reviews-section">
    <h2>My Reviews</h2>
    <% if (!locals.reviews || locals.reviews.length === 0) { %>
      <p>You have not written any reviews yet.</p>
    <% } else { %>
      <ul class="reviews-list">
        <% reviews.forEach(review => { %>
          <li>
            <!-- Entire review card is clickable -->
            <a class="review-item" href="/user/<%= user.user_id %>/review/<%= review.review_id %>" aria-label="View review for <%= review.book_title %>">
              <div class="review-header">
                <h3><%= review.book_title %></h3> <!-- Title -->
                <div class="star-rating">
                  <%
                    let stars = Math.round(review.rating / 2);
                    for (let i = 1; i <= 5; i++) {
                  %>
                    <span class="<%= i <= stars ? 'star filled' : 'star' %>">&#9733;</span>
                  <% } %>
                  <span class="rating-text">(<%= review.rating %>/10)</span> <!-- Rating -->
                </div>
              </div>

              <!-- Extra fields -->
              <div class="review-body">
                <div class="review-meta">
                  <strong>Rating:</strong> <%= review.rating %>/10
                </div>
                <p class="review-short"><%= review.short_description %></p> 
              </div>
              <img src="<%= review.book_cover || '/img/placeholder.jpg' %>" alt="Cover of <%= review.book_title %>" class="review-book-cover" />
            </a>

            <!-- Actions remain outside the clickable card -->
            <div class="review-actions">
              <a href="/auth/<%= user.user_id %>/edit-review/<%= review.review_id %>" 
                 class="btn btn-edit" title="Edit Review">‚úèÔ∏è Edit</a>
              <form
                action="/auth/<%= user.user_id %>/delete-review/<%= review.review_id %>"
                method="POST"
                class="delete-form"
                onsubmit="return confirm('Are you sure you want to delete this review?');"
              >
                <input type="hidden" name="review_id" value="<%= review.review_id %>" />
                <button type="submit" class="btn btn-delete" title="Delete Review">üóëÔ∏è Delete</button>
              </form>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </section>
</main>

<script>
  (function () {
    const books = <%- JSON.stringify(locals.books || []) %>;
    const userId = <%- JSON.stringify(user.user_id) %>;

    const toggle = document.getElementById('toggleAddReview');
    const content = document.getElementById('addReviewContent');
    const input = document.getElementById('bookSearch');
    const resultsEl = document.getElementById('bookResults');
    const fallback = document.getElementById('fallbackBooks');

    function setOpen(isOpen) {
      toggle.setAttribute('aria-expanded', String(isOpen));
      if (isOpen) {
        content.removeAttribute('hidden');
        toggle.textContent = 'Add a Review ‚ñæ';
        updateFallback();
        setTimeout(() => input && input.focus(), 0);
      } else {
        content.setAttribute('hidden', '');
        toggle.textContent = 'Add a Review ‚ñ∏';
        resultsEl.innerHTML = '';
      }
    }

    function updateFallback() {
      if (!fallback) return;
      const hasTerm = (input?.value || '').trim().length > 0;
      fallback.style.display = hasTerm ? 'none' : '';
    }

    if (toggle) {
      toggle.addEventListener('click', () => {
        const open = toggle.getAttribute('aria-expanded') === 'true';
        setOpen(!open);
      });
    }

    function renderResults(items) {
      resultsEl.innerHTML = '';
      if (!items.length) {
        const li = document.createElement('li');
        li.className = 'search-result-item empty';
        li.textContent = 'No matches';
        resultsEl.appendChild(li);
        return;
      }

      items.forEach(book => {
        const li = document.createElement('li');
        li.className = 'search-result-item';

        const img = document.createElement('img');
        img.src = book.book_cover || '/img/placeholder.jpg';
        img.alt = `Cover of ${book.title}`;

        const info = document.createElement('div');
        info.className = 'result-info';

        const title = document.createElement('h4');
        title.textContent = book.title;

        const meta = document.createElement('p');
        meta.textContent = `${book.author || 'Unknown'} ‚Ä¢ ${book.genre || 'N/A'}`;

        const action = document.createElement('a');
        action.className = 'btn btn-review';
        action.href = `/auth/${userId}/add-review/${book.book_id}`;
        action.title = `Add review for ${book.title}`;
        action.textContent = 'üìù Review';

        info.appendChild(title);
        info.appendChild(meta);

        li.appendChild(img);
        li.appendChild(info);
        li.appendChild(action);

        resultsEl.appendChild(li);
      });
    }

    function filter(term) {
      const t = term.trim().toLowerCase();
      updateFallback();
      if (!t) {
        resultsEl.innerHTML = '';
        return;
      }
      const matches = books
        .filter(b => (b.title || '').toLowerCase().includes(t))
        .slice(0, 10);
      renderResults(matches);
    }

    if (input) {
      input.addEventListener('input', (e) => filter(e.target.value));
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          input.value = '';
          filter('');
        }
      });
    }
  })();
</script>