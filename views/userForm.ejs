<main class="form-container">
    <h2 class="form-title"><%= locals.user ? 'Edit User' : 'Sign Up' %></h2>

    <% if (typeof error !== 'undefined') { %>
        <p class="form-error"><%= error %></p>
    <% } %>

    <form action="<%= locals.user ? '/auth/user/' + locals.user.user_id + '/edit' : '/register' %>" class="user-form" method="POST">
        <div class="form-group">
            <label for="name">Name</label>
            <input 
                type="text" 
                name="name" 
                id="name"
                value="<%= locals.user ? locals.user.name : '' %>"
                required 
                placeholder="<%= locals.user ? locals.user.name : 'Enter your full name' %>"
            />
        </div>
        
        <div class="form-group">
            <label for="email">Email</label>
            <input 
                type="email" 
                name="email" 
                id="email" 
                value="<%= locals.user ? locals.user.email : '' %>"
                required 
                placeholder="<%= locals.user ? locals.user.email : 'you@example.com' %>"
                <%= locals.user ? 'readonly' : '' %>
            />
        </div>

        <div class="form-group">
            <label for="password">Password</label>

            <!-- Change Password Button (only for editing an existing user) -->
            <% if (locals.user) { %>
                <button type="button" id="changePasswordBtn" class="change-password-btn btn-secondary btn-small">Change Password</button>
            <% } %>

            <input 
                type="password"
                name="password" 
                id="password" 
                <%= locals.user ? 'disabled' : 'required' %>
                placeholder="<%= locals.user ? 'Update your password?' : 'Create a password' %>"
            />      
        </div>

        <div class="form-group">
            <label for="phone_number">Phone</label>
            <input 
                type="tel" 
                name="phone_number" 
                id="phone_number"
                value="<%= locals.user ? locals.user.phone_number : '' %>"
                pattern="^\+?[\d\s\-\(\)]{7,15}$"
                placeholder="<%= locals.user ? locals.user.phone_number : '(555) 123-4567' %>"
            />
        </div>

        <div class="form-group">
            <label for="about">About You</label>
            <textarea 
                name="about" 
                id="about" 
                rows="3" 
                value="<%= locals.user ? locals.user.about : '' %>"
                placeholder="<%= locals.user ? locals.user.about : 'Tell us something about yourself!' %>"><%= locals.user ? locals.user.about : '' %></textarea>
        </div>

        <div class="form-group">
            <label for="favorite_book">Favorite Book</label>
            <select name="favorite_book_id" id="favorite_book_id">
                <option value="" disabled <%= locals.user && !locals.user.favorite_book_id ? 'selected' : '' %>>Select a book</option>
                <% if (locals.books) { %>
                    <% locals.books.forEach(book => { %>
                        <option value="<%= book.book_id %>" <%= locals.user && locals.user.favorite_book_id === book.book_id ? 'selected' : '' %>><%= book.title %></option>
                    <% }) %>
                <% } else { %>
                    <option value="" disabled>No books available</option>
                <% } %>
            </select>
        </div>

        <div class="form-group">
            <label for="user_color">Dashboard Theme</label>
                <div class="theme-grid">
                    <% const colors = ['pastel-blue', 'pastel-green', 'pastel-yellow', 'pastel-pink', 'pastel-purple', 'pastel-orange', 'pastel-red', 'pastel-gray', 'pastel-brown']; %>
                    <% colors.forEach(color => { %>
                    <label class="theme-box <%= color %>">
                        <input 
                        type="radio" 
                        name="user_color" 
                        value="<%= color %>" 
                        <%= (locals.user && locals.user.user_color === color) || (!locals.user && color === 'pastel-blue') ? 'checked' : '' %>
                        />
                    </label>
                <% }) %>
            </div> 
        </div>


        <button type="submit" class="btn btn-primary btn-center"><%= locals.user ? 'Save Changes' : 'Sign Up' %></button>
    </form>

    <% if (locals.user) { %>
        <!-- Delete Button triggers modal -->
        <button type="button" class="btn btn-danger btn-center" id="openDeleteModal">
            Delete User
        </button>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <h3>Confirm Deletion</h3>
                <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                
                <form action="/auth/user/<%= locals.user.user_id %>/delete" method="POST">
                    <button type="submit" class="btn btn-danger">Yes, Delete</button>
                    <button type="button" class="btn btn-secondary" id="cancelDelete">Cancel</button>
                </form>
            </div>
        </div>
    <% } %>

    <% if (!locals.user) { %>
        <p class="form-footer-text">
            Already have an account? <a href="/login">Login here</a>
        </p>
    <% } %>
</main>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const changeBtn = document.getElementById("changePasswordBtn");
        const passwordField = document.getElementById("password");

        const deleteBtn = document.getElementById("openDeleteModal");
        const deleteModal = document.getElementById("deleteModal");
        const cancelDelete = document.getElementById("cancelDelete");

        if (deleteBtn && deleteModal && cancelDelete) {
            deleteBtn.addEventListener("click", () => {
                deleteModal.style.display = "flex"; 
            });
            cancelDelete.addEventListener("click", () => {
                deleteModal.style.display = "none";
            });
        }

        if (changeBtn && passwordField) {
            changeBtn.addEventListener("click", () => {
                passwordField.disabled = false;
                passwordField.required = true;
                passwordField.focus();
                changeBtn.style.display = "none"; // hide button after clicked
            });
        }
    });

</script>